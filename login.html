<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<title>Clark Online Dating â€“ Private Chat</title>
<style>
body{margin:0;font-family:Arial;text-align:center;overflow:hidden;transition:0.3s;}
.bgDiv{position:fixed;inset:0;background-size:cover;opacity:0;transition:1.5s;filter:blur(2px);z-index:-2;}
.bgDiv.active{opacity:1;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:-1;}
header{background:rgba(255,77,109,.8);color:white;padding:15px;}
.chatBox{
  margin:30px auto;background:rgba(255,255,255,.85);
  width:90%;max-width:600px;padding:15px;border-radius:8px;
  display:none;
}
#messages{height:300px;overflow:auto;border:1px solid #ccc;padding:5px;margin:10px 0;}
input,select,button{padding:8px;margin:3px;width:90%;}
button{background:#ff4d6d;color:white;border:none;cursor:pointer;}
#authBox{margin:30px auto;background:rgba(255,255,255,.85);width:90%;max-width:400px;padding:15px;border-radius:8px;}
</style>
</head>
<body>

<!-- Background -->
<div id="bg1" class="bgDiv"></div>
<div id="bg2" class="bgDiv"></div>
<div class="overlay"></div>

<header>
<h2>Clark Private Chat</h2>
<button id="logout" style="display:none;">Logout</button>
</header>

<!-- Auth -->
<div id="authBox">
  <h3>Login / Sign Up</h3>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <input type="text" id="username" placeholder="Username"><br>
  <button id="signupBtn">Sign Up</button>
  <button id="loginBtn">Login</button>
</div>

<!-- Chat -->
<div class="chatBox" id="chatBox">
  <select id="users"></select>
  <div id="messages"></div>
  <input id="msg" placeholder="Message">
  <button id="send">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, onSnapshot, query, orderBy, getDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
 apiKey:"AIzaSyD_FcmcZpcCix8JMrP49w-KZd1N3c_EWho",
 authDomain:"clark-dating.firebaseapp.com",
 projectId:"clark-dating",
 appId:"1:274706009108:web:6e7309d20e788bc790ab01"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let me = null;
let selectedUser = null;

// DOM Elements
const authBox = document.getElementById("authBox");
const chatBox = document.getElementById("chatBox");
const usersSelect = document.getElementById("users");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msg");
const logoutBtn = document.getElementById("logout");

// -------------------
// Auth Functions
// -------------------
document.getElementById("signupBtn").onclick = async ()=>{
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const username = document.getElementById("username").value.trim();
  if(!email||!password||!username){ alert("Jaza fomu zote"); return; }
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    const uid = cred.user.uid;
    await setDoc(doc(db,"users",uid), { username, email });
    alert("Akaunti imeundwa!");
  }catch(e){ alert(e.message); }
};

document.getElementById("loginBtn").onclick = async ()=>{
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!email||!password){ alert("Ingiza email na password"); return; }
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(e){ alert(e.message); }
};

// -------------------
// Auth State Listener
// -------------------
onAuthStateChanged(auth, async user=>{
  if(user){
    me = user.uid;
    authBox.style.display="none";
    chatBox.style.display="block";
    logoutBtn.style.display="inline-block";
    loadUsers();
  }else{
    me = null;
    authBox.style.display="block";
    chatBox.style.display="none";
    logoutBtn.style.display="none";
  }
});

logoutBtn.onclick = ()=>signOut(auth);

// -------------------
// Load Users for private chat
// -------------------
async function loadUsers(){
  usersSelect.innerHTML="";
  const snap = await getDocs(collection(db,"users"));
  snap.forEach(docSnap=>{
    if(docSnap.id !== me){
      const u = docSnap.data();
      const opt = document.createElement("option");
      opt.value = docSnap.id;
      opt.textContent = u.username || u.email;
      usersSelect.appendChild(opt);
    }
  });
  if(usersSelect.options.length>0){
    selectedUser = usersSelect.value;
    loadMessages();
  }
}

usersSelect.onchange = ()=>{
  selectedUser = usersSelect.value;
  loadMessages();
};

// -------------------
// Send Private Message
// -------------------
document.getElementById("send").onclick = async ()=>{
  const m = msgInput.value.trim();
  if(!m || !selectedUser) return;
  await addDoc(collection(db,"privateMessages"),{
    from: me,
    to: selectedUser,
    message: m,
    timestamp: Date.now(),
    participants: [me, selectedUser]
  });
  msgInput.value="";
};

// -------------------
// Load messages for current pair
// -------------------
function loadMessages(){
  if(!selectedUser) return;
  const q = query(collection(db,"privateMessages"), orderBy("timestamp"));
  onSnapshot(q, snap=>{
    messagesDiv.innerHTML="";
    snap.forEach(doc=>{
      const d = doc.data();
      if(d.participants.includes(me) && d.participants.includes(selectedUser)){
        const div = document.createElement("div");
        div.textContent = `${d.from===me?"Me":"Them"}: ${d.message}`;
        messagesDiv.appendChild(div);
      }
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// -------------------
// Background crossfade
// -------------------
const images = [
  "https://images.pexels.com/photos/415829/pexels-photo-415829.jpeg",
  "https://images.pexels.com/photos/774909/pexels-photo-774909.jpeg",
  "https://images.pexels.com/photos/1181686/pexels-photo-1181686.jpeg",
  "https://images.pexels.com/photos/3769713/pexels-photo-3769713.jpeg"
];
let i=0,cur=1;
function bg(){
 const a=bg1,b=bg2,img=images[i++%images.length];
 if(cur===1){b.style.backgroundImage=`url(${img})`;b.classList.add("active");a.classList.remove("active");cur=2;}
 else{a.style.backgroundImage=`url(${img})`;a.classList.add("active");b.classList.remove("active");cur=1;}
}
bg();setInterval(bg,5000);

</script>
</body>
</html>
