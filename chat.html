<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clark Chat</title>

<style>
body{
  margin:0;
  font-family:Arial;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#111;
}

/* CHAT CONTAINER */
#chatContainer{
  display:flex;
  width:900px;
  height:600px;
  border-radius:15px;
  overflow:hidden;
  box-shadow:0 10px 25px rgba(0,0,0,0.5);
  background-size:cover;
  background-position:center;
  position:relative;
}

/* TRANSPARENT OVERLAY */
#overlay{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.25); /* transparency for readability */
  z-index:1;
}

/* USERS LIST */
.users{
  width:250px;
  background:rgba(0,0,0,0.7); /* dark sidebar */
  color:white;
  overflow-y:auto;
  padding:10px;
  z-index:2;
  position:relative;
}
.user{
  display:flex;
  align-items:center;
  padding:10px;
  cursor:pointer;
  border-radius:8px;
  margin-bottom:5px;
  transition:0.2s;
}
.user:hover{background:rgba(255,255,255,0.1);}
.user img{
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
  margin-right:10px;
}

/* CHAT AREA */
.chat{
  flex:1;
  display:flex;
  flex-direction:column;
  position:relative;
  z-index:2;
  background-size:cover;
  background-position:center;
}
.header{
  background:rgba(255,95,109,0.8);
  color:white;
  padding:15px;
  font-weight:bold;
  z-index:2;
}
.messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
  color:white;
  z-index:2;
}
.msg{
  max-width:65%;
  padding:10px 14px;
  margin:8px 0;
  border-radius:15px;
  font-size:14px;
}
.me{
  background:#ff5f6d;
  color:white;
  margin-left:auto;
}
.other{
  background:rgba(255,255,255,0.9);
  color:black;
}

/* INPUT */
.input{
  display:flex;
  background:rgba(0,0,0,0.4);
  padding:10px;
  z-index:2;
}
.input input{
  flex:1;
  padding:12px;
  border:none;
  outline:none;
  border-radius:10px;
  background:rgba(255,255,255,0.1);
  color:white;
}
.input input::placeholder{
  color:rgba(255,255,255,0.6);
}
.input button{
  padding:12px 20px;
  background:#ff5f6d;
  color:white;
  border:none;
  cursor:pointer;
  border-radius:10px;
  margin-left:10px;
}
</style>
</head>

<body>

<div id="chatContainer">
  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- USERS SIDEBAR -->
  <div class="users" id="users"></div>

  <!-- CHAT AREA -->
  <div class="chat" id="chatBox">
    <div class="header" id="chatName">Select a user</div>
    <div class="messages" id="messages"></div>
    <div class="input">
      <input id="msg" placeholder="Type message...">
      <button onclick="send()">Send</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDuAZOFqpyZoSH1FlbZ1G7O8YcNX63yDtM",
  authDomain: "clark-online-dating.firebaseapp.com",
  projectId: "clark-online-dating",
  storageBucket: "clark-online-dating.firebasestorage.app",
  messagingSenderId: "63074718758",
  appId: "1:63074718758:web:6af5283a9cdbbc1cef82e7"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
let currentChat = null;

/* BACKGROUND IMAGES */
const backgrounds = [
  "https://i.imgur.com/abc123.png", // replace na direct image link yako
  "https://i.imgur.com/def456.png",
  "https://i.imgur.com/ghi789.png"
];
let bgIndex = 0;
setInterval(()=>{
  const chatContainer = document.getElementById("chatContainer");
  chatContainer.style.backgroundImage = `url(${backgrounds[bgIndex]})`;
  chatContainer.style.backgroundSize = "cover";
  chatContainer.style.backgroundPosition = "center";
  bgIndex = (bgIndex + 1) % backgrounds.length;
}, 10000);

/* LOAD ALL USERS WALI OPO FIREBASE */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const usersRef = db.ref("users");
  usersRef.on("value", snapshot => { // <-- important change hapa
    const usersContainer = document.getElementById("users");
    usersContainer.innerHTML = ""; // clear old list
    snapshot.forEach(snap => {
      if(snap.key === auth.currentUser.uid) return;
      const u = snap.val();
      const name = u.name || "Anonymous";
      const photo = u.photo || "https://i.imgur.com/1X6sK5C.png";

      const div = document.createElement("div");
      div.className = "user";
      div.innerHTML = `<img src="${photo}"><div>${name}</div>`;
      div.onclick = ()=>openChat(snap.key, name);
      usersContainer.appendChild(div);
    });
  });
});

/* OPEN CHAT */
function openChat(uid,name){
  currentChat = uid;
  document.getElementById("chatName").innerText = name;
  document.getElementById("messages").innerHTML = "";

  const chatId = getChatId(uid);
  db.ref("chats/"+chatId).off();
  db.ref("chats/"+chatId).on("child_added",snap=>{
    const m = snap.val();
    const div = document.createElement("div");
    div.className = "msg " + (m.from === auth.currentUser.uid ? "me":"other");
    div.innerText = m.text;
    document.getElementById("messages").appendChild(div);
  });
}

/* SEND MESSAGE */
function send(){
  if(!currentChat){
    alert("Select a user first");
    return;
  }
  const text = msg.value.trim();
  if(text==="") return;
  msg.value="";

  db.ref("chats/"+getChatId(currentChat)).push({
    from: auth.currentUser.uid,
    text: text
  });
}

/* CHAT ID */
function getChatId(uid){
  return auth.currentUser.uid < uid
    ? auth.currentUser.uid + "_" + uid
    : uid + "_" + auth.currentUser.uid;
}
</script>

</body>
</html>
