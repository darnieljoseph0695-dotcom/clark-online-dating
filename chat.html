<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clark Chat</title>
<style>
*{box-sizing:border-box;font-family:Arial,sans-serif;margin:0;padding:0}
body{background:#f0f2f5;height:100vh;display:flex;justify-content:center;align-items:center}
.chat-container{width:100%;max-width:420px;height:90vh;background:#fff;display:flex;flex-direction:column;border-radius:20px;overflow:hidden;box-shadow:0 15px 50px rgba(0,0,0,.2)}
.chat-header{padding:15px;background:#fd267a;color:white;font-weight:bold;font-size:18px;text-align:center}
.messages{flex:1;padding:15px;overflow-y:auto;background:#ececec}
.bubble{padding:10px 14px;border-radius:20px;margin:5px 0;max-width:70%;font-size:14px}
.self{background:#4caf50;color:white;margin-left:auto}
.other{background:#ddd;margin-right:auto}
.input-area{display:flex;padding:10px;background:#f5f5f5}
.input-area input{flex:1;padding:10px;border-radius:20px;border:none;outline:none}
.input-area button{margin-left:8px;padding:0 16px;border:none;background:#fd267a;color:white;border-radius:50px;cursor:pointer}
.user-list{flex:1;overflow-y:auto;padding:10px;border-right:1px solid #ddd;background:#fafafa}
.user-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.user-item:hover{background:#f0f0f0}
.chat-main{flex:1;display:flex;flex-direction:column}
.flex-row{display:flex;flex:1;min-height:0}
</style>
</head>
<body>

<div class="chat-container">
 <div class="chat-header">Clark Chat</div>
 <div class="flex-row">
   <div class="user-list" id="userList">Loading matches...</div>
   <div class="chat-main">
     <div class="messages" id="messages"></div>
     <div class="input-area">
       <input id="msgInput" placeholder="Type a message">
       <button id="sendBtn">Send</button>
     </div>
   </div>
 </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, addDoc, doc, setDoc, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyA7MnRIlLQLoUr-mWbLNNFBbRsmMhRzai4",
  authDomain: "clark-online.firebaseapp.com",
  projectId: "clark-online",
  storageBucket: "clark-online.firebasestorage.app",
  messagingSenderId: "552869388337",
  appId: "1:552869388337:web:b37724d7f979c1a7407510",
  measurementId: "G-QQ9GM04TJB"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* DOM Elements */
const userList = document.getElementById("userList");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");

let me = null;
let currentChat = null;
let unsubMessages = null;

/* Helpers */
const convoId = (a,b)=>[a,b].sort().join("_");

/* Auth Check */
onAuthStateChanged(auth,user=>{
  if(!user){ alert("Login first"); window.location.href="index.html"; return; }
  me = user.uid;
  loadMatches();
});

/* Load Matches (users who liked each other) */
function loadMatches(){
  const q = query(collection(db,"matches"), where("users","array-contains",me));
  onSnapshot(q,snap=>{
    userList.innerHTML="";
    snap.forEach(d=>{
      const data = d.data();
      const otherUid = data.users.find(u=>u!==me);
      const div = document.createElement("div");
      div.className="user-item";
      div.textContent = data.name || "User";
      div.onclick = ()=>openChat(otherUid,data.name);
      userList.appendChild(div);
    });
  });
}

/* Open Chat */
function openChat(uid,name){
  currentChat = uid;
  messagesDiv.innerHTML="";
  if(unsubMessages) unsubMessages();
  const id = convoId(me,currentChat);
  const q = query(collection(db,"conversations",id,"messages"), orderBy("timestamp"));
  unsubMessages = onSnapshot(q,snap=>{
    messagesDiv.innerHTML="";
    snap.forEach(d=>{
      const m = d.data();
      const div = document.createElement("div");
      div.className = "bubble "+(m.from===me?"self":"other");
      div.textContent = m.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

/* Send Message */
async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text||!currentChat) return;
  const id = convoId(me,currentChat);
  await addDoc(collection(db,"conversations",id,"messages"),{
    from:me,
    text,
    timestamp:serverTimestamp()
  });
  msgInput.value="";
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown",e=>{ if(e.key==="Enter") sendMessage(); });
</script>

</body>
</html>

