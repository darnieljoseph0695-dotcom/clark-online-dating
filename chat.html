<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clark Chat</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#dadbd3;height:100vh}

.whatsapp{
 display:flex;
 height:100vh;
}

/* SIDEBAR */
.sidebar{
 width:30%;
 background:#fff;
 border-right:1px solid #ddd;
 display:flex;
 flex-direction:column;
}

.sidebar-header{
 background:#075e54;
 color:white;
 padding:15px;
 font-size:18px;
 font-weight:bold;
}

.user-list{
 flex:1;
 overflow-y:auto;
}

.chat-item{
 display:flex;
 gap:10px;
 padding:12px;
 cursor:pointer;
 border-bottom:1px solid #f0f0f0;
}
.chat-item:hover{background:#f5f5f5}

.avatar{
 width:40px;
 height:40px;
 background:#bbb;
 border-radius:50%;
 position:relative;
}

.online-dot{
 width:10px;
 height:10px;
 border-radius:50%;
 background:green;
 position:absolute;
 bottom:0;
 right:0;
 border:2px solid white;
}

/* CHAT AREA */
.chat-area{
 flex:1;
 display:flex;
 flex-direction:column;
 background:#efeae2;
}

.chat-area.hidden{display:none}

.chat-header{
 background:#075e54;
 color:white;
 padding:10px;
 display:flex;
 align-items:center;
 gap:10px;
}

.messages{
 flex:1;
 padding:15px;
 overflow-y:auto;
}

.bubble{
 max-width:70%;
 padding:8px 12px;
 margin:4px 0;
 border-radius:7px;
 font-size:14px;
}

.self{
 background:#dcf8c6;
 margin-left:auto;
}
.other{background:white}

/* INPUT */
.input-area{
 display:flex;
 padding:10px;
 background:#f0f0f0;
}

.input-area input{
 flex:1;
 padding:10px;
 border:none;
 border-radius:20px;
 outline:none;
}

.input-area button{
 margin-left:8px;
 width:40px;
 height:40px;
 border-radius:50%;
 border:none;
 background:#075e54;
 color:white;
 cursor:pointer;
}

/* MOBILE */
@media(max-width:768px){
 .sidebar{width:100%}
 .chat-area{position:fixed;inset:0}
}
</style>
</head>

<body>

<div class="whatsapp">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">Clark Chat</div>
    <div class="user-list" id="chatList">Loading users...</div>
  </div>

  <!-- CHAT -->
  <div class="chat-area hidden" id="chatWindow">
    <div class="chat-header">
      <div class="avatar"></div>
      <div>
        <strong id="chatName">User</strong><br>
        <small id="chatStatus">offline</small>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-area">
      <input id="msgInput" placeholder="Type a message">
      <button id="sendBtn">âž¤</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
 getFirestore, collection, query, orderBy,
 onSnapshot, addDoc, doc, setDoc,
 updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ BADILISHA HAPA */
const firebaseConfig = {
 apiKey: "YOUR_API_KEY",
 authDomain: "YOUR_DOMAIN",
 projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let me=null, currentChat=null, unsubMessages=null, unsubStatus=null;

const chatList=document.getElementById("chatList");
const chatWindow=document.getElementById("chatWindow");
const chatName=document.getElementById("chatName");
const chatStatus=document.getElementById("chatStatus");
const messages=document.getElementById("messages");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");

const convoId=(a,b)=>[a,b].sort().join("_");

/* AUTH + ONLINE */
onAuthStateChanged(auth,user=>{
 if(!user){
  alert("Login first");
  return;
 }
 me=user.uid;

 const myRef=doc(db,"users",me);

 updateDoc(myRef,{
  status:"online",
  lastSeen:serverTimestamp()
 });

 window.addEventListener("beforeunload",()=>{
  updateDoc(myRef,{
   status:"offline",
   lastSeen:serverTimestamp()
  });
 });

 loadUsers();
});

/* LOAD USERS */
function loadUsers(){
 const q=query(collection(db,"users"));
 onSnapshot(q,snap=>{
  chatList.innerHTML="";
  snap.forEach(d=>{
   if(d.id===me) return;
   const u=d.data();

   const div=document.createElement("div");
   div.className="chat-item";

   div.innerHTML=`
    <div class="avatar">
      ${u.status==="online" ? '<div class="online-dot"></div>' : ''}
    </div>
    <div>
      <strong>${u.name||"User"}</strong><br>
      <small>${u.status==="online"?"Online":"Offline"}</small>
    </div>
   `;

   div.onclick=()=>openChat(d.id,u.name||"User");
   chatList.appendChild(div);
  });
 });
}

/* OPEN CHAT */
function openChat(uid,name){
 currentChat=uid;
 chatName.textContent=name;
 chatWindow.classList.remove("hidden");
 watchStatus(uid);
 loadMessages();
}

/* WATCH ONLINE STATUS */
function watchStatus(uid){
 if(unsubStatus) unsubStatus();
 const ref=doc(db,"users",uid);
 unsubStatus=onSnapshot(ref,snap=>{
  const u=snap.data();
  if(!u) return;
  chatStatus.textContent =
   u.status==="online"
    ? "online"
    : "last seen " + new Date(u.lastSeen?.toDate()).toLocaleTimeString();
 });
}

/* LOAD MESSAGES */
function loadMessages(){
 if(unsubMessages) unsubMessages();

 const id=convoId(me,currentChat);
 const q=query(
  collection(db,"conversations",id,"messages"),
  orderBy("timestamp")
 );

 unsubMessages=onSnapshot(q,snap=>{
  messages.innerHTML="";
  snap.forEach(d=>{
   const m=d.data();
   const b=document.createElement("div");
   b.className="bubble "+(m.from===me?"self":"other");
   b.textContent=m.text;
   messages.appendChild(b);
  });
  messages.scrollTop=messages.scrollHeight;
 });
}

/* SEND MESSAGE */
async function sendMessage(){
 const text=msgInput.value.trim();
 if(!text||!currentChat) return;

 const id=convoId(me,currentChat);

 await addDoc(collection(db,"conversations",id,"messages"),{
  from:me,
  text,
  timestamp:serverTimestamp()
 });

 await setDoc(doc(db,"conversations",id),{
  participants:[me,currentChat],
  lastMessage:text,
  lastTimestamp:serverTimestamp()
 },{merge:true});

 msgInput.value="";
}

sendBtn.onclick=sendMessage;
msgInput.addEventListener("keydown",e=>{
 if(e.key==="Enter") sendMessage();
});
</script>

</body>
</html>
