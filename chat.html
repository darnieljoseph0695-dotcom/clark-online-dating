<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clark Chat</title>

<style>
body{
  margin:0;
  font-family:Arial;
  height:100vh;
  display:flex;
}

/* USERS LIST */
.users{
  width:30%;
  background:#111;
  color:white;
  overflow-y:auto;
}
.user{
  display:flex;
  align-items:center;
  padding:12px;
  cursor:pointer;
  border-bottom:1px solid #333;
}
.user img{
  width:45px;
  height:45px;
  border-radius:50%;
  object-fit:cover;
  margin-right:10px;
}
.user:hover{background:#222}

/* CHAT AREA */
.chat{
  width:70%;
  display:flex;
  flex-direction:column;
  background-size:cover;
  background-position:center;
}
.header{
  background:#ff5f6d;
  color:white;
  padding:15px;
  font-weight:bold;
}
.messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
}
.msg{
  max-width:65%;
  padding:10px 14px;
  margin:8px 0;
  border-radius:15px;
  font-size:14px;
}
.me{
  background:#ff5f6d;
  color:white;
  margin-left:auto;
}
.other{
  background:rgba(255,255,255,0.9);
  color:black;
}

/* INPUT */
.input{
  display:flex;
  background:white;
}
.input input{
  flex:1;
  padding:12px;
  border:none;
  outline:none;
}
.input button{
  padding:12px 20px;
  background:#ff5f6d;
  color:white;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- USERS -->
<div class="users" id="users"></div>

<!-- CHAT -->
<div class="chat" id="chatBox">
  <div class="header" id="chatName">Select a user</div>
  <div class="messages" id="messages"></div>
  <div class="input">
    <input id="msg" placeholder="Type message...">
    <button onclick="send()">Send</button>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDuAZOFqpyZoSH1FlbZ1G7O8YcNX63yDtM",
  authDomain: "clark-online-dating.firebaseapp.com",
  projectId: "clark-online-dating",
  storageBucket: "clark-online-dating.firebasestorage.app",
  messagingSenderId: "63074718758",
  appId: "1:63074718758:web:6af5283a9cdbbc1cef82e7"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let currentChat = null;

/* BACKGROUND ZA WADADA (AUTO CHANGE) */
const backgrounds = [
  "https://images.unsplash.com/photo-1494790108377-be9c29b29330",
  "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e",
  "https://images.unsplash.com/photo-1503342217505-b0a15ec3261c",
  "https://images.unsplash.com/photo-1517841905240-472988babdf9"
];

let bgIndex = 0;
setInterval(()=>{
  document.getElementById("chatBox").style.backgroundImage =
    `url(${backgrounds[bgIndex]})`;
  bgIndex = (bgIndex + 1) % backgrounds.length;
}, 7000);

/* LOAD USERS */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  db.ref("users").on("child_added",snap=>{
    if(snap.key === user.uid) return;

    const u = snap.val();
    const name = u.name || "Anonymous";
    const photo = u.photo || "https://i.imgur.com/1X6sK5C.png";

    const div = document.createElement("div");
    div.className="user";
    div.innerHTML = `
      <img src="${photo}">
      <div>${name}</div>
    `;
    div.onclick = ()=>openChat(snap.key, name);
    document.getElementById("users").appendChild(div);
  });
});

/* OPEN CHAT */
function openChat(uid,name){
  currentChat = uid;
  document.getElementById("chatName").innerText = name;
  document.getElementById("messages").innerHTML = "";

  const chatId = getChatId(uid);
  db.ref("chats/"+chatId).off();
  db.ref("chats/"+chatId).on("child_added",snap=>{
    const m = snap.val();
    const div = document.createElement("div");
    div.className = "msg " + (m.from === auth.currentUser.uid ? "me":"other");
    div.innerText = m.text;
    document.getElementById("messages").appendChild(div);
  });
}

/* SEND MESSAGE */
function send(){
  if(!currentChat){
    alert("Select a user first");
    return;
  }
  const text = msg.value.trim();
  if(text==="") return;
  msg.value="";

  db.ref("chats/"+getChatId(currentChat)).push({
    from: auth.currentUser.uid,
    text: text
  });
}

/* CHAT ID */
function getChatId(uid){
  return auth.currentUser.uid < uid
    ? auth.currentUser.uid + "_" + uid
    : uid + "_" + auth.currentUser.uid;
}
</script>

</body>
</html>
