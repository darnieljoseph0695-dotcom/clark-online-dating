<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clark Chat</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#ece5dd;height:100vh}

/* TOP BAR */
.topbar{
 background:#075e54;
 color:white;
 padding:15px;
 font-weight:bold;
}

/* APP LAYOUT */
.app{
 display:flex;
 height:calc(100vh - 50px);
}

/* CHAT LIST */
.chat-list{
 width:100%;
 background:white;
 overflow-y:auto;
}
.chat-item{
 padding:15px;
 border-bottom:1px solid #eee;
 cursor:pointer;
}
.chat-item strong{display:block}

/* CHAT WINDOW */
.chat-window{
 position:fixed;
 inset:0;
 background:#ece5dd;
 display:flex;
 flex-direction:column;
}
.chat-window.hidden{display:none}

.chat-header{
 background:#075e54;
 color:white;
 padding:10px;
 display:flex;
 align-items:center;
 gap:10px;
}

/* MESSAGES */
.messages{
 flex:1;
 padding:10px;
 overflow-y:auto;
}
.bubble{
 max-width:75%;
 padding:8px 12px;
 margin:4px 0;
 border-radius:8px;
 font-size:14px;
}
.self{
 background:#dcf8c6;
 margin-left:auto;
}
.other{
 background:white;
}

/* INPUT */
.input-area{
 display:flex;
 padding:8px;
 background:#f0f0f0;
}
.input-area input{
 flex:1;
 padding:10px;
 border-radius:20px;
 border:none;
 outline:none;
}
.input-area button{
 margin-left:5px;
 background:#075e54;
 color:white;
 border:none;
 border-radius:50%;
 width:40px;
 height:40px;
 cursor:pointer;
}

/* DESKTOP */
@media(min-width:768px){
 .chat-list{width:30%}
 .chat-window{
  position:relative;
  width:70%;
 }
 .chat-window.hidden{display:flex}
 #backBtn{display:none}
}
</style>
</head>

<body>

<div class="topbar">Clark Chat</div>

<div class="app">

  <div class="chat-list" id="chatList">
    Loading chats...
  </div>

  <div class="chat-window hidden" id="chatWindow">
    <div class="chat-header">
      <button id="backBtn">‚Üê</button>
      <span id="chatName">Chat</span>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-area">
      <input id="msgInput" placeholder="Message">
      <button id="sendBtn">‚û§</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
 getFirestore, collection, query, where,
 orderBy, onSnapshot, addDoc, doc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• FIREBASE CONFIG ‚Äî BADILISHA HAPA */
const firebaseConfig = {
 apiKey: "YOUR_API_KEY",
 authDomain: "YOUR_DOMAIN",
 projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let me = null;
let currentChat = null;

function convoId(a,b){
 return [a,b].sort().join("_");
}

/* AUTH */
onAuthStateChanged(auth,user=>{
 if(!user){
  alert("Login first");
  return;
 }
 me = user.uid;
 loadChats();
});

/* LOAD CHAT LIST */
function loadChats(){
 const q = query(
  collection(db,"conversations"),
  where("participants","array-contains",me),
  orderBy("lastTimestamp","desc")
 );

 onSnapshot(q,snap=>{
  chatList.innerHTML="";
  snap.forEach(d=>{
   const c=d.data();
   const other=c.participants.find(u=>u!==me);
   const div=document.createElement("div");
   div.className="chat-item";
   div.innerHTML=`
     <strong>${other}</strong>
     <small>${c.lastMessage||""}</small>
   `;
   div.onclick=()=>openChat(other);
   chatList.appendChild(div);
  });
 });
}

/* OPEN CHAT */
function openChat(uid){
 currentChat = uid;
 chatName.textContent = uid;
 chatWindow.classList.remove("hidden");
 loadMessages();
}

/* LOAD MESSAGES */
function loadMessages(){
 const id = convoId(me,currentChat);
 const q = query(
  collection(db,"conversations",id,"messages"),
  orderBy("timestamp")
 );

 onSnapshot(q,snap=>{
  messages.innerHTML="";
  snap.forEach(d=>{
   const m=d.data();
   const b=document.createElement("div");
   b.className="bubble "+(m.from===me?"self":"other");
   b.textContent=m.text;
   messages.appendChild(b);
  });
  messages.scrollTop=messages.scrollHeight;
 });
}

/* SEND MESSAGE */
sendBtn.onclick = async()=>{
 const text = msgInput.value.trim();
 if(!text || !currentChat) return;

 const id = convoId(me,currentChat);

 await addDoc(collection(db,"conversations",id,"messages"),{
  from: me,
  text: text,
  timestamp: serverTimestamp(),
  seen:false
 });

 await setDoc(doc(db,"conversations",id),{
  participants:[me,currentChat],
  lastMessage:text,
  lastTimestamp:serverTimestamp()
 },{merge:true});

 msgInput.value="";
};

backBtn.onclick=()=>chatWindow.classList.add("hidden");
</script>

</body>
</html>
