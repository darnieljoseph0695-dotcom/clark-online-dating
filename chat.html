<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<title>Clark Private Chat</title>
<style>
body {margin:0;font-family:Arial, sans-serif; height:100vh; display:flex; flex-direction:column;}

/* Background */
.bgDiv {position:fixed; inset:0; background-size:cover; background-position:center; opacity:0; transition:1.5s; filter:blur(2px); z-index:-2;}
.bgDiv.active {opacity:1;}
.overlay {position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:-1;}

/* Header */
header {background:rgba(255,77,109,0.85); color:white; padding:10px 15px; display:flex; justify-content:space-between; align-items:center; z-index:1;}
header h2 {margin:0;}
header button {padding:6px 12px; border:none; border-radius:5px; background:#fff; color:#ff4d6d; cursor:pointer;}

/* Main content: left users, right chat */
.main {display:flex; flex:1; overflow:hidden;}

/* Users sidebar */
#usersList {width:200px; background:rgba(255,255,255,0.9); overflow-y:auto; padding:10px; border-right:1px solid #ccc;}
.userItem {padding:8px; margin-bottom:5px; border-radius:5px; cursor:pointer; background:#f0f0f0;}
.userItem:hover {background:#e0e0e0;}
.userItem.active {background:#ff4d6d; color:white;}

/* Chat panel */
.chatPanel {flex:1; display:flex; flex-direction:column; padding:10px; background:rgba(255,255,255,0.85);}
#messages {flex:1; overflow-y:auto; padding:10px; border-radius:8px; background:#fff; border:1px solid #ccc; scroll-behavior:smooth;}
input {width:calc(100% - 90px); padding:8px; margin-right:5px;}
button#send {width:80px; padding:8px; background:#ff4d6d; color:white; border:none; cursor:pointer; border-radius:5px; margin-left:auto; display:inline-block;}

/* WhatsApp style bubbles */
.bubble {padding:8px; margin:5px 0; max-width:70%; border-radius:15px; word-wrap:break-word;}
.bubble.self {background:#dcf8c6; text-align:right; margin-left:auto; border-radius:15px 15px 0 15px;}
.bubble.other {background:#fff; border:1px solid #ccc; text-align:left; margin-right:auto; border-radius:15px 15px 15px 0;}
</style>
</head>
<body>

<div id="bg1" class="bgDiv"></div>
<div id="bg2" class="bgDiv"></div>
<div class="overlay"></div>

<header>
<h2>Clark Private Chat</h2>
<button id="logout">Logout</button>
</header>

<div class="main">
  <div id="usersList"></div>
  <div class="chatPanel">
    <div id="messages"></div>
    <div style="display:flex; margin-top:5px;">
      <input id="msg" placeholder="Type a message...">
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
 apiKey:"AIzaSyD_FcmcZpcCix8JMrP49w-KZd1N3c_EWho",
 authDomain:"clark-dating.firebaseapp.com",
 projectId:"clark-dating",
 appId:"1:274706009108:web:6e7309d20e788bc790ab01"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let me;
let selectedUserId;
let messagesUnsub;

// --- Auth ---
onAuthStateChanged(auth, async user => {
 if(!user) location="login.html";
 me = user.uid;
 loadUsers();
});

// --- Logout ---
logout.onclick = ()=>signOut(auth);

// --- Load users ---
async function loadUsers(){
 const list = document.getElementById("usersList");
 list.innerHTML = "";
 const snap = await getDocs(collection(db,"users"));
 snap.forEach(docSnap=>{
   if(docSnap.id!==me){
     const u = docSnap.data();
     const div = document.createElement("div");
     div.className="userItem";
     div.textContent = u.username || u.email || "Unnamed";
     div.dataset.uid = docSnap.id;
     div.onclick = ()=>{
       document.querySelectorAll('.userItem').forEach(el=>el.classList.remove('active'));
       div.classList.add('active');
       selectedUserId = docSnap.id;
       loadMessages(selectedUserId);
     };
     list.appendChild(div);
   }
 });
 // Auto-select first user
 const first = list.querySelector('.userItem');
 if(first){first.click();}
}

// --- Send message ---
send.onclick = async ()=>{
 const m = msg.value.trim();
 if(!m || !selectedUserId) return;
 await addDoc(collection(db,"privateMessages"), {
   participants: [me, selectedUserId],
   fromUid: me,
   message: m,
   timestamp: Date.now()
 });
 msg.value = "";
};

// --- Load messages ---
function loadMessages(otherUid){
 const q = query(collection(db,"privateMessages"), orderBy("timestamp"));
 if(messagesUnsub) messagesUnsub();
 messagesUnsub = onSnapshot(q, snap => {
   const div = document.getElementById("messages");
   div.innerHTML = "";
   snap.forEach(docSnap=>{
     const d = docSnap.data();
     if(d.participants.includes(me) && d.participants.includes(otherUid)){
       const b = document.createElement("div");
       b.textContent = d.message;
       b.classList.add("bubble", d.fromUid===me ? "self" : "other");
       div.appendChild(b);
     }
   });
   div.scrollTop = div.scrollHeight;
 });
}

// --- Background crossfade ---
const images = [
  "https://images.pexels.com/photos/415829/pexels-photo-415829.jpeg",
  "https://images.pexels.com/photos/774909/pexels-photo-774909.jpeg",
  "https://images.pexels.com/photos/1181686/pexels-photo-1181686.jpeg",
  "https://images.pexels.com/photos/3769713/pexels-photo-3769713.jpeg"
];
let i=0,cur=1;
function bg(){
 const a=bg1,b=bg2,img=images[i++%images.length];
 if(cur===1){b.style.backgroundImage=`url(${img})`;b.classList.add("active");a.classList.remove("active");cur=2;}
 else{a.style.backgroundImage=`url(${img})`;a.classList.add("active");b.classList.remove("active");cur=1;}
}
bg(); setInterval(bg,5000);
</script>
</body>
</html>
