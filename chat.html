<!DOCTYPE html>
<html>
<head>
  <title>Clark Chat</title>
</head>
<body>

<h3>Private Chat</h3>

<select id="users"></select>
<div id="chat" style="border:1px solid #ccc;height:300px;overflow:auto"></div>

<input id="msg" placeholder="Message">
<button id="send">Send</button>
<button id="logout">Logout</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, get } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_FcmcZpcCix8JMrP49w-KZd1N3c_EWho",
    authDomain: "clark-dating.firebaseapp.com",
    databaseURL: "https://clark-dating-default-rtdb.firebaseio.com",
    projectId: "clark-dating",
    appId: "1:274706009108:web:6e7309d20e788bc790ab01"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let me, chatId;

  onAuthStateChanged(auth, async user => {
    if (!user) location = "login.html";
    me = user.uid;

    const snap = await get(ref(db, "users"));
    users.innerHTML = "";
    snap.forEach(u => {
      if (u.key !== me) {
        users.innerHTML += `<option value="${u.key}">${u.key}</option>`;
      }
    });
  });

  users.onchange = () => {
    chat.innerHTML = "";
    chatId = [me, users.value].sort().join("_");
    onChildAdded(ref(db, "chats/" + chatId), s => {
      chat.innerHTML += `<p>${s.val().text}</p>`;
    });
  };

  send.onclick = () => {
    push(ref(db, "chats/" + chatId), {
      text: msg.value,
      sender: me
    });
    msg.value = "";
  };

  logout.onclick = () => signOut(auth);
</script>

</body>
</html>
