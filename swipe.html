<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clark Swipe</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif;}
body{min-height:100vh;background:linear-gradient(135deg,#fd267a,#ff6036);display:flex;justify-content:center;align-items:center;color:white;overflow:hidden;}
.app{width:100%;max-width:420px;padding:20px;text-align:center;}
.card{width:100%;height:540px;background-size:cover;background-position:center;border-radius:20px;box-shadow:0 25px 60px rgba(0,0,0,.4);cursor:grab;position:relative;animation:appear .4s ease;}
.card::after{content:"";position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.7),transparent);border-radius:20px;}
.info{position:absolute;bottom:20px;left:20px;z-index:2;text-align:left;}
.info h2{font-size:1.6rem;}
.info p{opacity:.9;}
.badge{position:absolute;top:20px;padding:10px 18px;border:3px solid;border-radius:10px;font-weight:700;font-size:1.1rem;opacity:0;}
.like{right:20px;color:#4caf50;border-color:#4caf50;transform:rotate(15deg);}
.nope{left:20px;color:#f44336;border-color:#f44336;transform:rotate(-15deg);}
.actions{display:flex;justify-content:space-around;margin-top:25px;}
.btn{width:60px;height:60px;border-radius:50%;background:white;display:flex;justify-content:center;align-items:center;font-size:1.8rem;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.3);}
.btn.like{color:#4caf50;}
.btn.nope{color:#f44336;}
.match{position:fixed;inset:0;background:linear-gradient(135deg,#fd267a,#ff6036);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;z-index:999;animation:fade .4s ease;}
.match h1{font-size:2.5rem;margin-bottom:10px;}
.match p{font-size:1.1rem;margin-bottom:20px;}
.match button{padding:12px 30px;border:none;border-radius:30px;font-size:1rem;font-weight:600;cursor:pointer;}
.hidden{display:none;}
@keyframes appear{from{opacity:0;transform:translateY(30px) scale(.95)}to{opacity:1;transform:none}}
@keyframes fade{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>
<div class="app">
 <div id="cardHolder"></div>
 <div class="actions">
  <div class="btn nope" onclick="manualSwipe(-1)">‚úñ</div>
  <div class="btn like" onclick="manualSwipe(1)">‚ù§</div>
 </div>
</div>

<div id="matchPopup" class="match hidden">
 <h1>üéâ It's a Match!</h1>
 <p>You and <span id="matchName"></span> like each other</p>
 <button onclick="closeMatch()">Continue</button>
</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { collection, doc, getDoc, getDocs, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let me = null;
const holder=document.getElementById("cardHolder");
const popup=document.getElementById("matchPopup");
const matchName=document.getElementById("matchName");
let index=0, profiles=[], activeCard=null;

/* AUTH CHECK */
onAuthStateChanged(auth,user=>{
 if(!user) window.location.href='index.html';
 me=user.uid;
 loadProfiles();
});

/* LOAD PROFILES */
async function loadProfiles(){
 const snap=await getDocs(collection(db,"users"));
 profiles=[];
 snap.forEach(d=>{
   if(d.id!==me) profiles.push({...d.data(), uid:d.id});
 });
 showCard();
}

/* SHOW CARD */
function showCard(){
 if(index>=profiles.length){ holder.innerHTML="<p>No more profiles</p>"; return; }
 const p=profiles[index];
 const card=document.createElement("div");
 card.className="card";
 card.style.backgroundImage=`url(${p.img})`;
 card.innerHTML=`
   <div class="badge like">LIKE</div>
   <div class="badge nope">NOPE</div>
   <div class="info">
    <h2>${p.name}, ${p.age}</h2>
    <p>üìç ${p.dist}</p>
   </div>
 `;
 holder.innerHTML="";
 holder.appendChild(card);
 activeCard=card;
 attachSwipe(card,p);
}

/* SWIPE LOGIC */
let startX=0,currentX=0,dragging=false;
function attachSwipe(card,p){
 const like=card.querySelector(".like");
 const nope=card.querySelector(".nope");
 card.addEventListener("mousedown",start); card.addEventListener("touchstart",start);
 document.addEventListener("mousemove",move); document.addEventListener("touchmove",move);
 document.addEventListener("mouseup",end); document.addEventListener("touchend",end);

 function start(e){ dragging=true; startX=e.touches?e.touches[0].clientX:e.clientX; card.style.transition="none";}
 function move(e){ if(!dragging)return;
  currentX=(e.touches?e.touches[0].clientX:e.clientX)-startX;
  card.style.transform=`translateX(${currentX}px) rotate(${currentX/15}deg)`;
  like.style.opacity=currentX>0?Math.min(currentX/100,1):0;
  nope.style.opacity=currentX<0?Math.min(-currentX/100,1):0;
 }
 function end(){ if(!dragging)return; dragging=false;
  if(Math.abs(currentX)>120){ swipe(card,currentX>0?1:-1,p); }else reset(card,like,nope);}
}
function swipe(card,dir,p){
 card.style.transition="transform .4s ease";
 card.style.transform=`translateX(${dir*1000}px) rotate(${dir*30}deg)`;

 if(dir===1) saveLike(p.uid);

 setTimeout(()=>{ index++; currentX=0; showCard(); },400);
}
function reset(card,like,nope){ card.style.transition="transform .3s ease"; card.style.transform="translateX(0)"; like.style.opacity=0; nope.style.opacity=0; currentX=0;}
function manualSwipe(dir){ if(activeCard) swipe(activeCard,dir,profiles[index]); }

/* SAVE LIKE + MATCH LOGIC */
async function saveLike(otherUid){
 const myRef=doc(db,"users",me,"likes",otherUid);
 await setDoc(myRef,{timestamp:serverTimestamp()});
 // check if other user liked me
 const otherLikeRef = doc(db,"users",otherUid,"likes",me);
 const docSnap = await getDoc(otherLikeRef);
 if(docSnap.exists()){
   showMatch(profiles[index].name);
   // create conversation
   const convoId = [me,otherUid].sort().join("_");
   await setDoc(doc(db,"conversations",convoId),{
     participants:[me,otherUid],
     lastTimestamp:serverTimestamp()
   },{merge:true});
 }
}

/* MATCH POPUP */
function showMatch(name){ matchName.textContent=name; popup.classList.remove("hidden"); }
function closeMatch(){ popup.classList.add("hidden"); }
</script>
</body>
</html>
